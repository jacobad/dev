<!------ controllers/validate/ValidateController.class.php --->

<?php

class ValidateController
{
    public function httpGetMethod(Http $http, array $queryFields)
    {
    	
        if(array_key_exists('user', $_SESSION) == false) {
            $http->redirectTo('/user/login');
        }
     

       
    }

    public function httpPostMethod(Http $http, array $formFields)
    {
     
    }
}

?>

<!------ controllers/validate/ValidateController.class.php --->

<h2><i class="fa fa-check"></i> Payer la commande</h2>

<section class="invoice">
    <p><strong><?= $_SESSION['user']['firstName'] ?> <?= $_SESSION['user']['lastName'] ?></strong></p>
    <p><?= $_SESSION['user']['address'] ?></p>
    <p><?= $_SESSION['user']['zipCode'] ?> <span class="city"><?= $_SESSION['user']['city'] ?></span></p>
</section>

<table class="generic-table meal-list">
    <caption>Récapitulatif de la commande</caption>
    <thead>
        <tr>
            <th>Nom</th>
            <th class="number">Quantité</th>
            <th class="number">Prix Unitaire</th>
            <th class="number">Prix Total</th>
        </tr>
    </thead>
    <tfoot>
        <tr>
            <td colspan="3">Total HT</td>
            <td id="totalht"></td>
        </tr>
        <tr>
            <td colspan="3">TVA (20%)</td>
            <td id="tva"></td>
        </tr>
        <tr>
            <td class="colorful" colspan="3">Total TTC</td>
            <td id="totalttc" class="colorful"></td>
        </tr>
    </tfoot>
    <tbody>

    </tbody>
</table>
<p style="text-align: center;">Commande validé le <?=date ("d")?>/<?= date ("m")?>/<?= date("y")?></p>
<hr>
<h3>Merci de bien vouloir procéder au paiement de la commande.</h3>
<form class="generic-form" action="<?= $requestUrl ?>/order/payment" method="POST">
	<ul>
        <input id="orderValidation" type="hidden" name="order" value="">
		<li>
			<input class="button button-primary" type="submit" value="Payer">
			<a class="button button-cancel small" href="<?= $requestUrl ?>">Annuler</a>
		</li>
	</ul>
</form>

<script src="<?= $wwwUrl ?>/js/classes/BasketSession.class.js"></script>
<script src="<?= $wwwUrl ?>/js/classes/RecapValidate.class.js"></script>

<!------ www/js/classes/BasketSession.class.js --->
<script>

'use strict';

var BasketSession = function()
{
    // Contenu du panier.
    this.items = null;

    this.load();
};



BasketSession.prototype.save = function()
{
    saveDataToDomStorage('panier', this.items);
};


BasketSession.prototype.load = function()
{
    this.items = loadDataFromDomStorage('panier');

    if(this.items == null)
    {
        this.items = [];
    }

	if (document.location.href.indexOf('order') != -1 && document.location.href.indexOf('order/validate') == -1) {

        this.build();
	} else {
    
    	this.buildRecap();
    }

};

BasketSession.prototype.add = function(mealId, name, quantity, salePrice, img)
{


    mealId    = parseInt(mealId);
    quantity  = parseInt(quantity);
    salePrice = parseFloat(salePrice);

    if(isNaN(quantity) == false) {
        $('#quantity').css('border', '1px solid grey');
        for(var index = 0; index < this.items.length; index++)
            {
                if(this.items[index].mealId == mealId)
                {
                    this.items[index].quantity += quantity;

                    this.save();
                    this.build();

                    return;
                }
            }

            this.items.push(
            {
                mealId    : mealId,
                name      : name,
                quantity  : quantity,
                salePrice : salePrice,
                img       : img
            });

            this.save();
            this.build();
            
    } else {
        $('#quantity').css('border', '1px solid red');
        alert('merci d\'indiquer la quantité');
    }

    

};

BasketSession.prototype.remove = function(index) {
    this.items.splice(index, 1);
    this.save();
    this.build();
}




BasketSession.prototype.build = function() {
	var table = $('<table class="generic-table">');

	table.append('<tr><td class="number"><strong>Quantité</strong></td><td><strong>Produit</strong></td><td class="number"><strong>Prix Unitaire</strong></td><td class="number"><strong>Prix Total</strong></td></tr>');

	for (var i =0; i < this.items.length; i++) {
		var tr = $('<tr>');
		tr.append('<td class="number">'+this.items[i].quantity+'</td><td ><strong>'+this.items[i].name+'</strong></td><td class="number">'+this.items[i].salePrice+'</td><td class="number">'+parseFloat(this.items[i].quantity)*parseFloat(this.items[i].salePrice)+' <button class="button trash button-cancel small" data-id="'+i+'"><i class="fa fa-trash"></i></button></td>');
		table.append(tr);
	}

	$('#order-summary').html(table);

}


BasketSession.prototype.buildRecap = function() {
	var priceHT = 0;
	$('.meal-list tbody').empty();
     for (var i=0; i < this.items.length; i++) {
        priceHT += parseFloat(this.items[i].quantity)*parseFloat(this.items[i].salePrice)
        
        var tr = $('<tr>');
        tr.append('<td><img src="'+this.items[i].img+'" width="25%">'+this.items[i].name+'</td><td class="number">'+this.items[i].quantity+'</td><td class="number">'+this.items[i].salePrice+'</td><td class="number">'+parseFloat(this.items[i].quantity)*parseFloat(this.items[i].salePrice)+'</td>')
        $('.meal-list tbody').append(tr);
    }
    
    var tva = (priceHT*0.2).toFixed(2);
    var ttc = (parseFloat(priceHT)+parseFloat(tva)).toFixed(2);
    
    $('#totalht').text(priceHT.toFixed(2)+' €');
    $('#tva').text(tva+' €');
    $('#totalttc').text(ttc+' €');
}

</script>

<!------ www/js/classes/RecapValidate.class.js --->
<script>
'use strict';

var RecapValidate = function()
{
	this.basket = new BasketSession();

	this.sendToPhp();
}

RecapValidate.prototype.sendToPhp = function() {
	var order = JSON.stringify(this.basket.items);
    
    $('#orderValidation').val(order);


}


</script>

<!------ www/js/main.js --->
<script>
if (document.location.href.indexOf('order') != -1 && document.location.href.indexOf('order/validate') == -1) {
	var order = new OrderForm();

}

if (document.location.href.indexOf('order/validate') != -1) {

	var validate = new RecapValidate();
}


</script>